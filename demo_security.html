<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Check Security Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log-area {
            background-color: #f8f9fa;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.75rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        .security-feature {
            background-color: #e7f3ff;
            border-left: 4px solid #0066cc;
            padding: 1rem;
            margin: 1rem 0;
        }
        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
        }
        .log-error {
            color: #dc3545;
        }
        .log-warning {
            color: #fd7e14;
        }
        .log-success {
            color: #198754;
        }
        .log-info {
            color: #0dcaf0;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <h1 class="text-center mb-4">ì´ë©”ì¼ ì²´í¬ ë³´ì•ˆ ë°ëª¨</h1>
                
                <div class="security-feature">
                    <h5>ğŸ”’ êµ¬í˜„ëœ ë³´ì•ˆ ì¡°ì¹˜</h5>
                    <ul class="mb-0">
                        <li><strong>Rate Limiting:</strong> IPë³„ 5ë¶„ê°„ 5íšŒ ì œí•œ</li>
                        <li><strong>CAPTCHA ê²€ì¦:</strong> ìë™í™” ë°©ì§€</li>
                        <li><strong>íšŒì›ê°€ì… í† í°:</strong> ì •ë‹¹í•œ í”Œë¡œìš°ì—ì„œë§Œ ì ‘ê·¼</li>
                        <li><strong>ë³´ì•ˆ ë¡œê¹…:</strong> ëª¨ë“  ì‹œë„ ì¶”ì </li>
                    </ul>
                </div>

                <!-- Step 1: Generate Signup Token -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>1ë‹¨ê³„: íšŒì›ê°€ì… í† í° ìƒì„±</h5>
                    </div>
                    <div class="card-body">
                        <p>ë¨¼ì € íšŒì›ê°€ì… í”Œë¡œìš°ë¥¼ ì‹œì‘í•˜ê¸° ìœ„í•´ í† í°ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.</p>
                        <button id="generateTokenBtn" class="btn btn-primary">í† í° ìƒì„±</button>
                        <div id="tokenInfo" class="mt-3" style="display: none;">
                            <div class="alert alert-success">
                                <strong>í† í° ìƒì„± ì„±ê³µ!</strong><br>
                                í† í°: <code id="signupToken"></code><br>
                                ë‚¨ì€ ì´ë©”ì¼ ì²´í¬ íšŸìˆ˜: <span id="remainingChecks"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Email Check -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>2ë‹¨ê³„: ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸</h5>
                    </div>
                    <div class="card-body">
                        <form id="emailCheckForm">
                            <div class="mb-3">
                                <label for="email" class="form-label">ì´ë©”ì¼ ì£¼ì†Œ</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            
                            <!-- CAPTCHA Section (initially hidden) -->
                            <div id="captchaSection" class="mb-3" style="display: none;">
                                <label class="form-label">ë³´ì•ˆ ê²€ì¦</label>
                                <div class="alert alert-warning">
                                    <strong>CAPTCHA í•„ìš”:</strong> <span id="captchaQuestion"></span>
                                </div>
                                <input type="hidden" id="captchaId">
                                <input type="number" class="form-control" id="captchaAnswer" placeholder="ë‹µì„ ì…ë ¥í•˜ì„¸ìš”">
                            </div>
                            
                            <button type="submit" class="btn btn-success" id="checkEmailBtn">ì´ë©”ì¼ í™•ì¸</button>
                            <button type="button" class="btn btn-warning" id="simulateAttackBtn">ê³µê²© ì‹œë®¬ë ˆì´ì…˜</button>
                        </form>
                    </div>
                </div>

                <!-- Results -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>ê²°ê³¼ ë° ë¡œê·¸</h5>
                    </div>
                    <div class="card-body">
                        <div id="resultArea" class="mb-3"></div>
                        <div class="log-area" id="logArea"></div>
                        <button class="btn btn-secondary btn-sm mt-2" onclick="clearLogs()">ë¡œê·¸ ì§€ìš°ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let signupToken = '';
        let currentCaptchaId = '';
        let attackAttempts = 0;

        // Utility functions
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            const logArea = document.getElementById('logArea');
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function showResult(message, type = 'info') {
            const resultArea = document.getElementById('resultArea');
            resultArea.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        function clearLogs() {
            document.getElementById('logArea').innerHTML = '';
            document.getElementById('resultArea').innerHTML = '';
        }

        // Step 1: Generate signup token
        document.getElementById('generateTokenBtn').addEventListener('click', async function() {
            try {
                log('íšŒì›ê°€ì… í† í° ìƒì„± ìš”ì²­...', 'info');
                
                // Simulate API call
                const response = await simulateTokenGeneration();
                
                if (response.success) {
                    signupToken = response.signup_token;
                    document.getElementById('signupToken').textContent = signupToken.substring(0, 16) + '...';
                    document.getElementById('remainingChecks').textContent = response.email_checks_allowed;
                    document.getElementById('tokenInfo').style.display = 'block';
                    
                    log('íšŒì›ê°€ì… í† í° ìƒì„± ì„±ê³µ', 'success');
                    showResult('íšŒì›ê°€ì… í† í°ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ì´ë©”ì¼ í™•ì¸ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    log('í† í° ìƒì„± ì‹¤íŒ¨: ' + response.message, 'error');
                    showResult('í† í° ìƒì„± ì‹¤íŒ¨: ' + response.message, 'danger');
                }
            } catch (error) {
                log('í† í° ìƒì„± ì˜¤ë¥˜: ' + error.message, 'error');
                showResult('í† í° ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        });

        // Step 2: Email check
        document.getElementById('emailCheckForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!signupToken) {
                showResult('ë¨¼ì € íšŒì›ê°€ì… í† í°ì„ ìƒì„±í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            const email = document.getElementById('email').value;
            const captchaAnswer = document.getElementById('captchaAnswer').value;
            
            await performEmailCheck(email, captchaAnswer);
        });

        // Attack simulation
        document.getElementById('simulateAttackBtn').addEventListener('click', async function() {
            attackAttempts++;
            log(`ê³µê²© ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ (ì‹œë„ #${attackAttempts})`, 'warning');
            
            const testEmails = [
                'admin@example.com',
                'user@example.com', 
                'test@example.com',
                'noreply@example.com',
                'contact@example.com'
            ];
            
            for (let i = 0; i < testEmails.length; i++) {
                log(`ëŒ€ëŸ‰ ì´ë©”ì¼ ì²´í¬ ì‹œë„: ${testEmails[i]}`, 'warning');
                
                // Simulate rapid requests without proper token
                const response = await simulateEmailCheck(testEmails[i], '', '', '');
                
                if (response.status === 429) {
                    log('Rate Limit ë°œë™! ê³µê²© ì°¨ë‹¨ë¨', 'error');
                    showResult('ğŸš« ê³µê²©ì´ íƒì§€ë˜ì–´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. Rate Limitingì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.', 'danger');
                    break;
                } else if (response.status === 401) {
                    log('ì¸ì¦ ì‹¤íŒ¨! í† í° ì—†ì´ ì ‘ê·¼ ì°¨ë‹¨ë¨', 'error');
                    showResult('ğŸš« ì¸ì¦ë˜ì§€ ì•Šì€ ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'danger');
                    break;
                }
                
                // Delay between requests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        });

        // Simulate email check
        async function performEmailCheck(email, captchaAnswer) {
            try {
                log(`ì´ë©”ì¼ í™•ì¸ ìš”ì²­: ${email}`, 'info');
                
                const response = await simulateEmailCheck(email, signupToken, currentCaptchaId, captchaAnswer);
                
                if (response.status === 200) {
                    const data = response.data;
                    log(`ì´ë©”ì¼ í™•ì¸ ì™„ë£Œ: ${data.exists ? 'ì‚¬ìš© ì¤‘' : 'ì‚¬ìš© ê°€ëŠ¥'}`, 'success');
                    showResult(`âœ… ${data.message}<br>ë‚¨ì€ ìš”ì²­ ìˆ˜: ${data.rate_limit.remaining}`, 'success');
                    
                    // Hide CAPTCHA on success
                    document.getElementById('captchaSection').style.display = 'none';
                    
                } else if (response.status === 422 && response.data.captcha_required) {
                    log('CAPTCHA ê²€ì¦ í•„ìš”', 'warning');
                    showCaptcha(response.data.captcha);
                    
                } else if (response.status === 429) {
                    log('Rate Limit ì´ˆê³¼', 'error');
                    showResult(`âš ï¸ ${response.data.message}<br>ì¬ì‹œë„ ê°€ëŠ¥ ì‹œê°„: ${new Date(response.data.rate_limit.reset_time * 1000).toLocaleTimeString()}`, 'warning');
                    
                } else {
                    log(`ìš”ì²­ ì‹¤íŒ¨ (${response.status}): ${response.data.message}`, 'error');
                    showResult(`âŒ ${response.data.message}`, 'danger');
                }
                
            } catch (error) {
                log('ì´ë©”ì¼ í™•ì¸ ì˜¤ë¥˜: ' + error.message, 'error');
                showResult('ì´ë©”ì¼ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        function showCaptcha(captcha) {
            document.getElementById('captchaQuestion').textContent = captcha.question;
            document.getElementById('captchaId').value = captcha.challenge_id;
            currentCaptchaId = captcha.challenge_id;
            document.getElementById('captchaSection').style.display = 'block';
            document.getElementById('captchaAnswer').value = '';
            document.getElementById('captchaAnswer').focus();
            
            showResult('ë³´ì•ˆì„ ìœ„í•´ CAPTCHA ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
        }

        // Simulation functions (ì‹¤ì œ API ëŒ€ì‹  ë³´ì•ˆ ë¡œì§ ì‹œë®¬ë ˆì´ì…˜)
        const simulationState = {
            requests: [],
            tokens: {},
            captchas: {}
        };

        function simulateTokenGeneration() {
            const now = Date.now();
            const recentRequests = simulationState.requests.filter(req => 
                req.action === 'token_gen' && (now - req.timestamp) < 600000 // 10ë¶„
            );
            
            if (recentRequests.length >= 3) {
                return Promise.resolve({
                    success: false,
                    message: 'í† í° ìƒì„± ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
                });
            }
            
            simulationState.requests.push({
                action: 'token_gen',
                timestamp: now
            });
            
            const token = 'signup_' + Math.random().toString(36).substring(2, 15);
            simulationState.tokens[token] = {
                created_at: now,
                email_checks_count: 0
            };
            
            return Promise.resolve({
                success: true,
                signup_token: token,
                expires_in: 1800,
                email_checks_allowed: 5
            });
        }

        function simulateEmailCheck(email, signupToken, captchaId, captchaAnswer) {
            const now = Date.now();
            
            // Rate limiting check
            const recentRequests = simulationState.requests.filter(req => 
                req.action === 'email_check' && (now - req.timestamp) < 300000 // 5ë¶„
            );
            
            if (recentRequests.length >= 5) {
                return Promise.resolve({
                    status: 429,
                    data: {
                        success: false,
                        message: 'ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
                        exists: false,
                        rate_limit: {
                            reset_time: Math.floor((recentRequests[0].timestamp + 300000) / 1000),
                            remaining: 0
                        }
                    }
                });
            }
            
            // Token validation
            if (!signupToken || !simulationState.tokens[signupToken]) {
                return Promise.resolve({
                    status: 401,
                    data: {
                        success: false,
                        message: 'ì´ ê¸°ëŠ¥ì€ íšŒì›ê°€ì… ê³¼ì •ì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                        exists: false,
                        error_code: 'AUTH_REQUIRED'
                    }
                });
            }
            
            const tokenData = simulationState.tokens[signupToken];
            
            // Token expiry check
            if (now - tokenData.created_at > 1800000) { // 30ë¶„
                delete simulationState.tokens[signupToken];
                return Promise.resolve({
                    status: 401,
                    data: {
                        success: false,
                        message: 'íšŒì›ê°€ì… ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œì‘í•´ì£¼ì„¸ìš”.',
                        exists: false,
                        error_code: 'INVALID_TOKEN'
                    }
                });
            }
            
            // Email check limit
            if (tokenData.email_checks_count >= 5) {
                return Promise.resolve({
                    status: 401,
                    data: {
                        success: false,
                        message: 'ì´ë©”ì¼ í™•ì¸ íšŸìˆ˜ ì œí•œì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.',
                        exists: false,
                        error_code: 'LIMIT_EXCEEDED'
                    }
                });
            }
            
            // CAPTCHA requirement (always for demo)
            if (!captchaId || !captchaAnswer) {
                const captcha = generateCaptcha();
                return Promise.resolve({
                    status: 422,
                    data: {
                        success: false,
                        message: 'ë³´ì•ˆì„ ìœ„í•´ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.',
                        exists: false,
                        captcha_required: true,
                        captcha: captcha,
                        error_code: 'CAPTCHA_REQUIRED'
                    }
                });
            }
            
            // CAPTCHA validation
            if (!simulationState.captchas[captchaId] || 
                simulationState.captchas[captchaId].answer !== parseInt(captchaAnswer)) {
                const newCaptcha = generateCaptcha();
                return Promise.resolve({
                    status: 422,
                    data: {
                        success: false,
                        message: 'ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
                        exists: false,
                        captcha_required: true,
                        captcha: newCaptcha,
                        error_code: 'CAPTCHA_FAILED'
                    }
                });
            }
            
            // Success case
            simulationState.requests.push({
                action: 'email_check',
                timestamp: now
            });
            
            tokenData.email_checks_count++;
            delete simulationState.captchas[captchaId];
            
            const exists = Math.random() > 0.5; // ëœë¤í•˜ê²Œ ì¡´ì¬/ë¹„ì¡´ì¬ ê²°ì •
            
            return Promise.resolve({
                status: 200,
                data: {
                    success: true,
                    exists: exists,
                    message: exists ? 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.' : 'ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë©”ì¼ì…ë‹ˆë‹¤.',
                    rate_limit: {
                        remaining: 5 - recentRequests.length - 1,
                        reset_time: Math.floor((now + 300000) / 1000)
                    },
                    signup_flow: {
                        remaining_checks: 5 - tokenData.email_checks_count
                    }
                }
            });
        }

        function generateCaptcha() {
            const num1 = Math.floor(Math.random() * 10) + 1;
            const num2 = Math.floor(Math.random() * 10) + 1;
            const operations = ['+', '-', '*'];
            const operation = operations[Math.floor(Math.random() * operations.length)];
            
            let answer;
            switch (operation) {
                case '+':
                    answer = num1 + num2;
                    break;
                case '-':
                    if (num1 < num2) [num1, num2] = [num2, num1];
                    answer = num1 - num2;
                    break;
                case '*':
                    answer = num1 * num2;
                    break;
            }
            
            const challengeId = 'captcha_' + Math.random().toString(36).substring(2, 15);
            simulationState.captchas[challengeId] = {
                answer: answer,
                created_at: Date.now()
            };
            
            return {
                question: `${num1} ${operation} ${num2} = ?`,
                challenge_id: challengeId
            };
        }

        // Initial log
        log('ë³´ì•ˆ ë°ëª¨ í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        log('ì´ í˜ì´ì§€ëŠ” ì´ë©”ì¼ ì²´í¬ ë³´ì•ˆ ì¡°ì¹˜ë¥¼ ì‹œì—°í•©ë‹ˆë‹¤.', 'info');
    </script>
</body>
</html>